name: PR Quality Check

# è§¦å‘æ¡ä»¶ï¼šå‘ develop æˆ– main åˆ†æ”¯æäº¤ PR æ—¶
on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, ready_for_review]
    paths-ignore:
      - "**.md"
      - "docs/**"
  issue_comment:
    types: [created]
# å¢åŠ å¹¶å‘æ§åˆ¶ï¼Œé¿å…é‡å¤è¿è¡Œæµªè´¹èµ„æº
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.issue.number || github.ref }}
  cancel-in-progress: true

# æƒé™é…ç½® (AI Review éœ€è¦å†™è¯„è®ºæƒé™)
permissions:
  contents: write # ğŸ‘ˆ å¿…é¡»æ”¹ä¸º write (ç”¨äºæäº¤ä»£ç å»ºè®®/gitæ“ä½œ)
  pull-requests: write # ç”¨äºå†™è¯„è®ºã€ä¿®æ”¹ PR æè¿°
  issues: write # ğŸ‘ˆ æ–°å¢ (å› ä¸º PR è¯„è®ºåœ¨ GitHub ä¹Ÿå°±æ˜¯ Issue è¯„è®º)

jobs:
  # ----------------------------------------------------------------
  # 1 é™æ€ä»£ç åˆ†æç»„ (å¹¶è¡Œè¿è¡Œï¼Œé€Ÿåº¦å¿«)
  # ----------------------------------------------------------------

  # 1.1 Commit è§„èŒƒæ£€æŸ¥
  commit-check:
    name: ğŸ“ Commit Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Commitlint éœ€è¦å®Œæ•´çš„ commit å†å²
      # âœ… 1. ä½¿ç”¨ä½ å°è£…å¥½çš„ Setup Project
      # è¿™ä¼šå®‰è£… pnpmï¼Œå¹¶è¿è¡Œ pnpm installï¼Œç¡®ä¿å®‰è£…äº†é¡¹ç›®é‡ŒæŒ‡å®šç‰ˆæœ¬çš„ commitlint
      - name: Setup Project
        uses: ./.github/actions/setup-project
      # âœ… 2. ä½¿ç”¨ pnpm exec è¿è¡Œæœ¬åœ°å®‰è£…çš„ commitlint
      # è¿™æ ·å®ƒä¼šè‡ªåŠ¨è¯»å–é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ commitlint.config.js
      - name: Validate Commits
        run: pnpm exec commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
  # 1.2 [æ–°å¢] ä¾èµ–å®‰å…¨å®¡æŸ¥
  dependency-review:
    name: ğŸ›¡ï¸ Dep Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high # åªæœ‰é«˜å±æ¼æ´æ‰é˜»æ–­åˆå¹¶

  # 1.3 æ‹¼å†™æ£€æŸ¥
  spell-check:
    name: ğŸ”¤ Spell Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request' || contains(github.event.comment.body, '/retest')
    steps:
      - uses: actions/checkout@v4
      - uses: crate-ci/typos@master

  # 1.4 æ­»é“¾æ£€æŸ¥
  link-check:
    name: ğŸ”— Link Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request' || contains(github.event.comment.body, '/retest')
    steps:
      - uses: actions/checkout@v4
      - uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --verbose
            --no-progress
            --timeout 30
            --retry-wait-time 5
            --max-retries 3
            './**/*.md'
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # -----------------------------------------
  # æ„å»ºä¸æµ‹è¯•ç»„
  # -----------------------------------------
  # ä»»åŠ¡ 2.1: æ„å»ºæ£€æŸ¥ & å•å…ƒæµ‹è¯• (å¹¶è¡Œè¿è¡Œçš„åŸºç¡€)
  quality-check:
    name: ğŸ—ï¸ Build & Unit Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if:
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'issue_comment'
      && github.event.issue.pull_request
      && contains(github.event.comment.body, '/retest'))
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/merge', github.event.issue.number) || '' }}
      - name: Setup Project
        uses: ./.github/actions/setup-project

      # âœ… Build Check: ç¡®ä¿èƒ½æ‰“åŒ…ï¼Œæ— ç±»å‹é”™è¯¯
      - name: ğŸ“¦ Build Check
        run: pnpm build

      # âœ… Unit Test: å…¨é‡å•å…ƒæµ‹è¯•
      - name: ğŸ§ª Unit Test
        run: pnpm test:run

  #      - name: Upload Coverage Report
  #        if: always()
  #        uses: actions/upload-artifact@v4
  #        with:
  #          name: coverage-report
  #          path: coverage/
  #          retention-days: 7

  # ä»»åŠ¡ 2.2: E2E å†’çƒŸæµ‹è¯• (åªè·‘å…³é”®è·¯å¾„)
  e2e-smoke:
    name: ğŸ­ E2E Smoke Test
    runs-on: ubuntu-latest
    needs: quality-check
    timeout-minutes: 20
    if: (github.event_name == 'pull_request'
      && github.event.pull_request.draft == false) ||
      (github.event_name == 'issue_comment'
      && github.event.issue.pull_request
      && contains(github.event.comment.body, '/retest'))
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/merge', github.event.issue.number) || '' }}
      - name: Setup Project
        uses: ./.github/actions/setup-project

      # è·å– Playwright ç‰ˆæœ¬ç”¨äºç¼“å­˜ Key
      - name: Get installed Playwright version
        id: playwright-version
        run: echo "PLAYWRIGHT_VERSION=$(node -p 'require("@playwright/test/package.json").version')" >> $GITHUB_ENV

      # ç¼“å­˜æµè§ˆå™¨äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Cache playwright binaries
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}
      # åªæœ‰ç¼“å­˜æœªå‘½ä¸­æ‰å®‰è£…æµè§ˆå™¨
      # å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œä»ç„¶éœ€è¦è¿è¡Œ install-deps (åªå®‰è£…ç³»ç»Ÿä¾èµ–)
      #    å› ä¸ºç¼“å­˜åªå­˜äº†æµè§ˆå™¨äºŒè¿›åˆ¶æ–‡ä»¶ (~/.cache/ms-playwright)ï¼Œæ²¡å­˜ apt-get å®‰è£…çš„ç³»ç»Ÿåº“ï¼
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps

      - name: Install Playwright System Dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps

      - name: ğŸš€ Run Smoke Tests
        run: pnpm exec playwright test --grep @smoke --retries=2

  #      - name: Upload Playwright Report
  #        if: always()
  #        uses: actions/upload-artifact@v4
  #        with:
  #          name: playwright-report
  #          path: playwright-report/
  #          retention-days: 7

  # ä»»åŠ¡ 2.3: AI ä»£ç å®¡æŸ¥ (Non-blocking)
  ai-review:
    name: ğŸ¤– AI Code Review
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.draft == false) ||
      (github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/review'))
    continue-on-error: true # âœ… å…³é”®ï¼šå³ä½¿ AI æŠ¥é”™æˆ–è¶…æ—¶ï¼Œä¹Ÿä¸é˜»æ­¢ PR åˆå¹¶
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/merge', github.event.issue.number) || '' }}
      - name: Qodo-AI PR-Agent
        id: ai-review-step
        uses: qodo-ai/pr-agent@main
        env:
          # API é…ç½®
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE: https://api.gptapi.us/v1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # æ¨¡å‹é…ç½®
          config.model: "openai/deepseek-chat"
          config.fallback_models: '["openai/deepseek-r1","openai/deepseek-r1-0528","openai/deepseek-v3","openai/deepseek-v3.1"]'
          config.custom_model_max_tokens: "128000"

          # åŠŸèƒ½é…ç½®
          github_action_config.auto_review: "true"
          github_action_config.auto_describe: "true"
          github_action_config.auto_improve: "true"
          github_action_config.pr_actions: '["opened", "reopened", "ready_for_review", "review_requested"]'

      - name: Report AI Review Status
        if: always()
        run: |
          if [ "${{ steps.ai-review-step.outcome }}" == "failure" ]; then
            echo "âš ï¸ AI Review failed but not blocking PR"
            echo "::warning::AI Code Review encountered an error"
          else
            echo "âœ… AI Review completed successfully"
          fi
  ci-status-label:
    name: Update CI Status Label
    runs-on: ubuntu-latest
    needs: [quality-check, e2e-smoke]
    if: |
      always() && 
      (github.event_name == 'pull_request' || 
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/retest')))
    steps:
      - name: Add or Remove ci-failed label
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = 'ci-failed';

            const qualityResult = '${{ needs.quality-check.result }}';
            const e2eResult = '${{ needs.e2e-smoke.result }}';

            // åˆ¤æ–­æ˜¯å¦æœ‰å¤±è´¥ï¼ˆè·³è¿‡ä¸ç®—å¤±è´¥ï¼‰
            const hasFailed = qualityResult === 'failure' || e2eResult === 'failure';

            // è·å–å½“å‰ PR çš„æ‰€æœ‰æ ‡ç­¾
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner,
              repo,
              issue_number: prNumber,
            });
            const hasLabel = currentLabels.some(l => l.name === label);

            // å¦‚æœè¢«å–æ¶ˆï¼Œä¸åšä»»ä½•æ“ä½œ
            if (qualityResult === 'cancelled' || e2eResult === 'cancelled') {
              console.log('â¹ï¸ CI was cancelled, skipping label update');
              return;
            }

            if (hasFailed && !hasLabel) {
              // CI å¤±è´¥ï¼Œæ·»åŠ æ ‡ç­¾
              console.log('âŒ CI failed, adding label');
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: prNumber,
                labels: [label],
              });
            } else if (!hasFailed && hasLabel) {
              // CI é€šè¿‡ï¼Œç§»é™¤æ ‡ç­¾
              console.log('âœ… CI passed, removing label');
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: prNumber,
                name: label,
              });
            } else {
              console.log(`â„¹ï¸ No label change needed (failed: ${hasFailed}, hasLabel: ${hasLabel})`);
            }
