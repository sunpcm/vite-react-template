name: PR Quality Check

# è§¦å‘æ¡ä»¶ï¼šå‘ develop æˆ– main åˆ†æ”¯æäº¤ PR æ—¶
on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created, edited]

# å¢åŠ å¹¶å‘æ§åˆ¶ï¼Œé¿å…é‡å¤è¿è¡Œæµªè´¹èµ„æº
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# æƒé™é…ç½® (AI Review éœ€è¦å†™è¯„è®ºæƒé™)
permissions:
  contents: write # ğŸ‘ˆ å¿…é¡»æ”¹ä¸º write (ç”¨äºæäº¤ä»£ç å»ºè®®/gitæ“ä½œ)
  pull-requests: write # ç”¨äºå†™è¯„è®ºã€ä¿®æ”¹ PR æè¿°
  issues: write # ğŸ‘ˆ æ–°å¢ (å› ä¸º PR è¯„è®ºåœ¨ GitHub ä¹Ÿå°±æ˜¯ Issue è¯„è®º)

jobs:
  # ä»»åŠ¡ 1: æ„å»ºæ£€æŸ¥ & å•å…ƒæµ‹è¯• (å¹¶è¡Œè¿è¡Œçš„åŸºç¡€)
  quality-check:
    name: ğŸ—ï¸ Build & Unit Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # âœ… Build Check: ç¡®ä¿èƒ½æ‰“åŒ…ï¼Œæ— ç±»å‹é”™è¯¯
      - name: ğŸ“¦ Build Check
        run: pnpm build

      # âœ… Unit Test: å…¨é‡å•å…ƒæµ‹è¯•
      - name: ğŸ§ª Unit Test
        run: pnpm test:run

  # ä»»åŠ¡ 2: E2E å†’çƒŸæµ‹è¯• (åªè·‘å…³é”®è·¯å¾„)
  e2e-smoke:
    name: ğŸ­ E2E Smoke Test
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # è·å– Playwright ç‰ˆæœ¬ç”¨äºç¼“å­˜ Key
      - name: Get installed Playwright version
        id: playwright-version
        run: echo "PLAYWRIGHT_VERSION=$(pnpm ls @playwright/test --json | jq '.[0].version' -r)" >> $GITHUB_ENV

      # ç¼“å­˜æµè§ˆå™¨äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Cache playwright binaries
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}

      # åªæœ‰ç¼“å­˜æœªå‘½ä¸­æ‰å®‰è£…æµè§ˆå™¨
      # å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œä»ç„¶éœ€è¦è¿è¡Œ install-deps (åªå®‰è£…ç³»ç»Ÿä¾èµ–)
      #    å› ä¸ºç¼“å­˜åªå­˜äº†æµè§ˆå™¨äºŒè¿›åˆ¶æ–‡ä»¶ (~/.cache/ms-playwright)ï¼Œæ²¡å­˜ apt-get å®‰è£…çš„ç³»ç»Ÿåº“ï¼
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps

      - name: Install Playwright System Dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps

      - name: ğŸš€ Run Smoke Tests
        run: pnpm exec playwright test --grep @smoke

  # ä»»åŠ¡ 3: AI ä»£ç å®¡æŸ¥ (Non-blocking)
  ai-review:
    name: ğŸ¤– AI Code Review
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/review'))
    continue-on-error: true # âœ… å…³é”®ï¼šå³ä½¿ AI æŠ¥é”™æˆ–è¶…æ—¶ï¼Œä¹Ÿä¸é˜»æ­¢ PR åˆå¹¶
    # âš ï¸ æƒé™å¿…é¡»é…ç½®ï¼PR-Agent éœ€è¦æ¯”æ™®é€š Reviewer æ›´é«˜çš„æƒé™
    permissions:
      issues: write # å…è®¸åœ¨ PR é‡Œå‘è¯„è®º
      pull-requests: write # å…è®¸ä¿®æ”¹ PR è¯¦æƒ…ï¼ˆå¦‚è‡ªåŠ¨å¡« Descriptionï¼‰
      contents: write # å…è®¸æäº¤ä»£ç å»ºè®®

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Qodo-AI PR-Agent
        uses: qodo-ai/pr-agent@main
        env:
          # API é…ç½®
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE: https://api.gptapi.us/v1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # æ¨¡å‹é…ç½®
          config.model: "openai/deepseek-chat"
          config.fallback_models: '["openai/deepseek-r1","openai/deepseek-r1-0528","openai/deepseek-v3","openai/deepseek-v3.1"]'
          config.custom_model_max_tokens: "128000"

          # åŠŸèƒ½é…ç½®
          github_action_config.auto_review: "true"
          github_action_config.auto_describe: "true"
          github_action_config.auto_improve: "true"
          github_action_config.pr_actions: '["opened", "reopened", "ready_for_review", "review_requested"]'
