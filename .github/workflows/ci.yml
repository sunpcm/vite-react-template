name: PR Quality Check

# è§¦å‘æ¡ä»¶ï¼šå‘ develop æˆ– main åˆ†æ”¯æäº¤ PR æ—¶
on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created, edited]

# æƒé™é…ç½® (AI Review éœ€è¦å†™è¯„è®ºæƒé™)
permissions:
  contents: write # ğŸ‘ˆ å¿…é¡»æ”¹ä¸º write (ç”¨äºæäº¤ä»£ç å»ºè®®/gitæ“ä½œ)
  pull-requests: write # ç”¨äºå†™è¯„è®ºã€ä¿®æ”¹ PR æè¿°
  issues: write # ğŸ‘ˆ æ–°å¢ (å› ä¸º PR è¯„è®ºåœ¨ GitHub ä¹Ÿå°±æ˜¯ Issue è¯„è®º)

jobs:
  # ä»»åŠ¡ 1: æ„å»ºæ£€æŸ¥ & å•å…ƒæµ‹è¯• (å¹¶è¡Œè¿è¡Œçš„åŸºç¡€)
  quality-check:
    name: ğŸ—ï¸ Build & Unit Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # âœ… Build Check: ç¡®ä¿èƒ½æ‰“åŒ…ï¼Œæ— ç±»å‹é”™è¯¯
      - name: ğŸ“¦ Build Check
        run: pnpm build

      # âœ… Unit Test: å…¨é‡å•å…ƒæµ‹è¯•
      - name: ğŸ§ª Unit Test
        run: pnpm test:run

  # ä»»åŠ¡ 2: E2E å†’çƒŸæµ‹è¯• (åªè·‘å…³é”®è·¯å¾„)
  e2e-smoke:
    name: ğŸ­ E2E Smoke Test
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ğŸ‘‡ æ–°å¢ï¼šè·å– Playwright ç‰ˆæœ¬ç”¨äºç¼“å­˜ Key
      - name: Get installed Playwright version
        id: playwright-version
        run: echo "PLAYWRIGHT_VERSION=$(pnpm ls @playwright/test --json | jq '.[0].version' -r)" >> $GITHUB_ENV

      # ğŸ‘‡ æ–°å¢ï¼šç¼“å­˜æµè§ˆå™¨äºŒè¿›åˆ¶æ–‡ä»¶
      - name: Cache playwright binaries
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}

      # ğŸ‘‡ ä¿®æ”¹ï¼šåªæœ‰ç¼“å­˜æœªå‘½ä¸­æ‰å®‰è£…æµè§ˆå™¨
      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps

      - name: ğŸš€ Run Smoke Tests
        run: pnpm exec playwright test --grep @smoke

  # ä»»åŠ¡ 3: AI ä»£ç å®¡æŸ¥ (Non-blocking)
  ai-review:
    name: ğŸ¤– AI Code Review
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.event_name == 'pull_request'
    continue-on-error: true # âœ… å…³é”®ï¼šå³ä½¿ AI æŠ¥é”™æˆ–è¶…æ—¶ï¼Œä¹Ÿä¸é˜»æ­¢ PR åˆå¹¶

    # âš ï¸ æƒé™å¿…é¡»é…ç½®ï¼PR-Agent éœ€è¦æ¯”æ™®é€š Reviewer æ›´é«˜çš„æƒé™
    permissions:
      issues: write # å…è®¸åœ¨ PR é‡Œå‘è¯„è®º
      pull-requests: write # å…è®¸ä¿®æ”¹ PR è¯¦æƒ…ï¼ˆå¦‚è‡ªåŠ¨å¡« Descriptionï¼‰
      contents: write # å…è®¸æäº¤ä»£ç å»ºè®®

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ•µï¸ Debug Secrets
          # ğŸ‘‡ ç¬¬ä¸€æ­¥ï¼šåœ¨è¿™é‡ŒæŠŠ Secret æ˜ å°„ç»™ç¯å¢ƒå˜é‡
        env:
          MY_URL: ${{ secrets.API_BASE_URL }}
        run: |
          echo "=== Debugging ==="
          
          # 1. è¿™ç§å†™æ³•æ˜¯é”™çš„ï¼ŒShell ä¸è®¤è¯† GitHub çš„ secrets å¯¹è±¡
          # è¾“å‡ºç»“æœé€šå¸¸æ˜¯ ".API_BASE_URL" (å‰é¢çš„ $secrets ä¹Ÿå°±æ˜¯ç©º)
          echo "âŒ Wrong way: $secrets.API_BASE_URL"
          
          # 2. è¿™ç§å†™æ³•æ˜¯å¯¹çš„ï¼Œä½†è¾“å‡ºä¼šè¢«è‡ªåŠ¨æ‰“ç æˆ ***
          echo "âœ… Raw (Masked): $MY_URL"
          
          # 3.è¿™æ˜¯ä½ è¦çš„â€œç»•è¿‡å±è”½â€å†™æ³•ï¼Œæ­£ç¡®ï¼
          echo "ğŸ”“ Unmasked: $(echo "$MY_URL" | sed 's/./& /g')"
          
          echo "=== End Debug ==="

      # è¿™é‡Œä½¿ç”¨ä¸€ä¸ªæµè¡Œçš„å¼€æº Action ä½œä¸ºç¤ºä¾‹ (éœ€è¦é…ç½® OPENAI_API_KEY)
      # ä½ ä¹Ÿå¯ä»¥æ›¿æ¢ä¸º CodeRabbit ç­‰ç¬¬ä¸‰æ–¹åº”ç”¨

      - name: CodiumAI PR-Agent
        uses: Codium-ai/pr-agent@main
        env:
          # ğŸ‘‡ å…³é”®é…ç½® 1: ä¼ å…¥ API Key
          # å¦‚æœä½ æ˜¯ç”¨ DeepSeekï¼Œè¿™é‡Œå°±æŠŠå€¼è®¾ä¸ºä½ çš„ DeepSeek Key
          # PR-Agent å†…éƒ¨é»˜è®¤è®¤ "OPENAI_API_KEY" è¿™ä¸ªå˜é‡åï¼Œä¸ç®¡æ˜¯å“ªå®¶æ¨¡å‹
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}

          # GitHub Token ä¹Ÿæ˜¯å¿…é¡»çš„
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # ğŸ‘‡ å…³é”®é…ç½® 2: å‘Šè¯‰å®ƒæ€ä¹ˆç”¨ DeepSeek
          PR_AGENT_CONFIG_VARS: |
            # ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ–°å¢è¿™ä¸¤è¡Œé…ç½® ğŸ‘‡ğŸ‘‡ğŸ‘‡
            # å…è®¸åœ¨ PR æ›´æ–°(synchronize)æ—¶è‡ªåŠ¨è¿è¡Œ Review
            github_action.auto_review=true
            # å…è®¸åœ¨ PR æ›´æ–°(synchronize)æ—¶è‡ªåŠ¨æ›´æ–° PR æè¿°
            github_action.auto_describe=true
            # å¼ºåˆ¶æ›¿æ¢ OpenAI çš„åœ°å€ä¸º DeepSeek
            openai.base_url=https://api.gptapi.us/v1
            openai.api_type=openai

            # æŒ‡å®šæ¨¡å‹
            config.model=deepseek-chat
            config.model_turbo=deepseek-chat
            config.fallback_models=["deepseek-r1","deepseek-r1-0528","deepseek-v3","deepseek-v3.1","deepseek-v3.1-terminus"]

            # è®¾å®šè¯­è¨€ä¸ºä¸­æ–‡
            extra_settings.language="Chinese"

            #å“ªæ€• AI æŠ¥é”™ä¹Ÿä¸è¦è®© Action å¤±è´¥
            config.ignore_pr_agent_errors=true
            
            # ğŸ‘‡ æ–°å¢ï¼šå¼€å¯è¯¦ç»†æ—¥å¿—
            config.verbosity_level=2
            
            # ğŸ‘‡ ä¿®æ”¹ï¼šè°ƒè¯•æœŸé—´ä¸å…è®¸å¿½ç•¥é”™è¯¯ï¼Œå¦åˆ™çœ‹ä¸åˆ°æŠ¥é”™
            config.ignore_pr_agent_errors=false
